<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Linear mixed models: examples in R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="tutorial-hac_files/libs/clipboard/clipboard.min.js"></script>
<script src="tutorial-hac_files/libs/quarto-html/quarto.js"></script>
<script src="tutorial-hac_files/libs/quarto-html/popper.min.js"></script>
<script src="tutorial-hac_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="tutorial-hac_files/libs/quarto-html/anchor.min.js"></script>
<link href="tutorial-hac_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="tutorial-hac_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="tutorial-hac_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="tutorial-hac_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="tutorial-hac_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="3">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#load-libraries" id="toc-load-libraries" class="nav-link active" data-scroll-target="#load-libraries">Load libraries</a></li>
  <li><a href="#simulate-data" id="toc-simulate-data" class="nav-link" data-scroll-target="#simulate-data">Simulate data</a></li>
  <li><a href="#linear-models" id="toc-linear-models" class="nav-link" data-scroll-target="#linear-models">Linear models</a>
  <ul class="collapse">
  <li><a href="#simple-regression" id="toc-simple-regression" class="nav-link" data-scroll-target="#simple-regression">Simple regression</a></li>
  <li><a href="#multiple-regression" id="toc-multiple-regression" class="nav-link" data-scroll-target="#multiple-regression">Multiple regression</a></li>
  <li><a href="#mulitple-regression-with-interaction" id="toc-mulitple-regression-with-interaction" class="nav-link" data-scroll-target="#mulitple-regression-with-interaction">Mulitple regression with interaction</a></li>
  </ul></li>
  <li><a href="#linear-mixed-models" id="toc-linear-mixed-models" class="nav-link" data-scroll-target="#linear-mixed-models">Linear mixed models</a>
  <ul class="collapse">
  <li><a href="#random-intercept" id="toc-random-intercept" class="nav-link" data-scroll-target="#random-intercept">Random intercept</a>
  <ul class="collapse">
  <li><a href="#predicting-the-random-intercept" id="toc-predicting-the-random-intercept" class="nav-link" data-scroll-target="#predicting-the-random-intercept">Predicting the random intercept</a></li>
  </ul></li>
  <li><a href="#random-slope" id="toc-random-slope" class="nav-link" data-scroll-target="#random-slope">Random slope</a></li>
  <li><a href="#nested-design" id="toc-nested-design" class="nav-link" data-scroll-target="#nested-design">Nested design</a></li>
  <li><a href="#crossed-design" id="toc-crossed-design" class="nav-link" data-scroll-target="#crossed-design">Crossed design</a></li>
  <li><a href="#models-with-interaction" id="toc-models-with-interaction" class="nav-link" data-scroll-target="#models-with-interaction">Models with interaction</a></li>
  <li><a href="#model-selection-and-comparisons-using-lrt" id="toc-model-selection-and-comparisons-using-lrt" class="nav-link" data-scroll-target="#model-selection-and-comparisons-using-lrt">Model selection and comparisons using LRT</a></li>
  </ul></li>
  <li><a href="#try-it-yourself" id="toc-try-it-yourself" class="nav-link" data-scroll-target="#try-it-yourself">Try it yourself</a>
  <ul class="collapse">
  <li><a href="#vaccine-study" id="toc-vaccine-study" class="nav-link" data-scroll-target="#vaccine-study">Vaccine study</a></li>
  <li><a href="#vaccine-study-1" id="toc-vaccine-study-1" class="nav-link" data-scroll-target="#vaccine-study-1">Vaccine study</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Linear mixed models: examples in R</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This notebook shows fitting some of the common examples of linear mixed models, including models with random intercept, random intercept and slope, nested design, and crossed design. The examples are based on the <strong>simulated data</strong> with a grouped trend, nested trend and crossed trend and implemented in R using the <code>lme4</code> package.</p>
<p>In try it yourself section, you can find instructions to practice the linear mixed models on some other data sets.</p>
<p>More details can be found under <a href="https://payamemami.com/linear_mixed_models/">https://payamemami.com/linear_mixed_models/</a></p>
<section id="load-libraries" class="level1">
<h1>Load libraries</h1>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tidyverse"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"lme4"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"emmeans"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"performance"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"ggiraphExtra"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="simulate-data" class="level1">
<h1>Simulate data</h1>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># grouped trend</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>simulate_grouped_trend <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">group_count =</span> <span class="dv">5</span>, <span class="at">points_per_group =</span> <span class="dv">10</span>, <span class="at">global_slope =</span> <span class="sc">-</span><span class="dv">10</span>, <span class="at">global_intercept =</span> <span class="dv">30</span>, <span class="at">group_slope =</span> <span class="dv">2</span>, <span class="at">noise_sd =</span> <span class="dv">50</span>) {</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># Setting a seed for reproducibility</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize an empty data frame to store the simulated data</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">numeric</span>(), <span class="at">y =</span> <span class="fu">numeric</span>())</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop to create each group</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>group_count) {</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    x_start <span class="ot">&lt;-</span> <span class="dv">12</span> <span class="sc">+</span> (i <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> (<span class="dv">10</span> <span class="sc">/</span> group_count) <span class="co"># Stagger the start of x for each group</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">runif</span>(points_per_group, <span class="at">min =</span> x_start, <span class="at">max =</span> x_start <span class="sc">+</span> (<span class="dv">10</span> <span class="sc">/</span> group_count))</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply a local positive trend within the group, but maintain the global negative trend</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    local_intercept <span class="ot">&lt;-</span> global_intercept <span class="sc">+</span> global_slope <span class="sc">*</span> (x_start <span class="sc">+</span> (<span class="dv">10</span> <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> group_count))) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> noise_sd)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> local_intercept <span class="sc">+</span> group_slope <span class="sc">*</span> (x <span class="sc">-</span> x_start) <span class="sc">+</span> <span class="fu">rnorm</span>(points_per_group, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> noise_sd)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine this group with the overall dataset</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    group_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> x, <span class="at">y =</span> y,<span class="at">group=</span>i)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> <span class="fu">rbind</span>(data, group_data)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co"># generate simulated data</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>data_int <span class="ot">&lt;-</span> <span class="fu">simulate_grouped_trend</span>(<span class="at">group_count =</span> <span class="dv">4</span>,<span class="at">points_per_group =</span> <span class="dv">10</span>,<span class="at">global_slope =</span> <span class="sc">-</span><span class="dv">2</span>,<span class="at">global_intercept =</span> <span class="dv">100</span>,<span class="at">group_slope =</span> <span class="dv">4</span>,<span class="at">noise_sd =</span> <span class="dv">5</span>)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co"># set group to factor</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>data_int<span class="sc">$</span>group <span class="ot">&lt;-</span> <span class="fu">factor</span>(data_int<span class="sc">$</span>group)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="co"># nested trend</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>simulate_grouped_trend_nested <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">region_count =</span> <span class="dv">3</span>, <span class="at">clinics_per_region =</span> <span class="dv">5</span>, <span class="at">measurements_per_clinic =</span> <span class="dv">10</span>,</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">global_slope =</span> <span class="sc">-</span><span class="dv">10</span>, <span class="at">global_intercept =</span> <span class="dv">30</span>, </span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">region_effects =</span> <span class="fu">c</span>(), <span class="at">region_slopes =</span> <span class="fu">c</span>(),</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">clinic_effects =</span> <span class="fu">list</span>(), <span class="at">clinic_slopes =</span> <span class="fu">list</span>()) {</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># Setting a seed for reproducibility</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize an empty data frame to store the simulated data</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">numeric</span>(), <span class="at">y =</span> <span class="fu">numeric</span>(), <span class="at">clinic =</span> <span class="fu">integer</span>(), <span class="at">region =</span> <span class="fu">integer</span>())</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>  clinic_id_counter <span class="ot">=</span> <span class="dv">1</span> <span class="co"># Initialize a counter for clinic IDs across regions</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop to create data for each region</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (region <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>region_count) {</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use the specific region effect and slope</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    region_effect_adj <span class="ot">=</span> region_effects[region]</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    region_slope_adj <span class="ot">=</span> region_slopes[region]</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop to create data for each clinic within a region</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (clinic <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>clinics_per_region) {</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>      x_start <span class="ot">=</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">10</span>) <span class="sc">+</span> <span class="dv">10</span> <span class="sc">*</span> (clinic <span class="sc">-</span> <span class="dv">1</span>) <span class="co"># More continuous x values across clinics</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>      x <span class="ot">=</span> <span class="fu">runif</span>(measurements_per_clinic, <span class="at">min =</span> x_start, <span class="at">max =</span> x_start <span class="sc">+</span> <span class="dv">10</span>) <span class="co"># Continuous x for measurements</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Use the specific clinic effect and slope</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>      clinic_effect <span class="ot">=</span> clinic_effects[[region]][clinic]</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>      clinic_slope <span class="ot">=</span> clinic_slopes[[region]][clinic]</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Simulate measurements for each clinic</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>measurements_per_clinic) {</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Model y incorporating both global and specific slopes and effects</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>        y <span class="ot">=</span> (global_intercept <span class="sc">+</span> region_effect_adj <span class="sc">+</span> clinic_effect) <span class="sc">+</span> </span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>            (global_slope <span class="sc">+</span> region_slope_adj <span class="sc">+</span> clinic_slope) <span class="sc">*</span> x[i] <span class="sc">+</span> </span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>) <span class="co"># Assuming measurement_noise_sd is constant for simplicity</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Combine this measurement with the overall dataset</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">=</span> <span class="fu">rbind</span>(data, <span class="fu">data.frame</span>(<span class="at">x =</span> x[i], <span class="at">y =</span> y, <span class="at">clinic =</span> clinic_id_counter, <span class="at">region =</span> region))</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>      clinic_id_counter <span class="ot">&lt;-</span> clinic_id_counter <span class="sc">+</span> <span class="dv">1</span> <span class="co"># Increment clinic ID for unique identification across regions</span></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10</span>)</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>data_int_nested <span class="ot">&lt;-</span><span class="fu">simulate_grouped_trend_nested</span>(<span class="at">region_count =</span> <span class="dv">4</span>,</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">clinics_per_region =</span> <span class="dv">3</span>,</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">measurements_per_clinic =</span> <span class="dv">20</span>,</span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">global_slope =</span> <span class="dv">0</span>,<span class="at">global_intercept =</span> <span class="dv">100</span>,</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">region_effects =</span> <span class="fu">rnorm</span>(<span class="dv">4</span>,<span class="at">mean =</span> <span class="dv">0</span>,<span class="at">sd =</span> <span class="dv">20</span>),</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">region_slopes=</span><span class="fu">rnorm</span>(<span class="dv">4</span>,<span class="at">mean =</span> <span class="fl">0.1</span>,<span class="at">sd =</span> <span class="dv">2</span>),</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>       <span class="at">clinic_effects =</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,<span class="cf">function</span>(i){<span class="fu">rnorm</span>(<span class="dv">3</span>,<span class="at">mean =</span> <span class="dv">0</span>,<span class="at">sd =</span> <span class="dv">10</span>)}),</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>      <span class="at">clinic_slopes =</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,<span class="cf">function</span>(i){<span class="fu">rnorm</span>(<span class="dv">3</span>,<span class="at">mean =</span> <span class="fl">0.1</span>,<span class="at">sd =</span> <span class="dv">1</span>)}))</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a><span class="co"># crossed trend</span></span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>simulate_grouped_trend_crossed <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">clinic_count =</span> <span class="dv">3</span>, <span class="at">doctor_count =</span> <span class="dv">5</span>, <span class="at">measurements_per_combination =</span> <span class="dv">10</span>,</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">global_slope =</span> <span class="sc">-</span><span class="dv">10</span>, <span class="at">global_intercept =</span> <span class="dv">30</span>,</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">clinic_effects =</span> <span class="fu">c</span>(), <span class="at">clinic_slopes =</span> <span class="fu">c</span>(),</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">doctor_effects =</span> <span class="fu">c</span>(), <span class="at">doctor_slopes =</span> <span class="fu">c</span>()) {</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># Setting a seed for reproducibility</span></span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize an empty data frame to store the simulated data</span></span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">numeric</span>(), <span class="at">y =</span> <span class="fu">numeric</span>(), <span class="at">doctor =</span> <span class="fu">integer</span>(), <span class="at">clinic =</span> <span class="fu">integer</span>())</span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Validate or adjust lengths of effects and slopes arrays to match counts</span></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(clinic_effects) <span class="sc">!=</span> clinic_count) clinic_effects <span class="ot">&lt;-</span> <span class="fu">rep</span>(clinic_effects[<span class="dv">1</span>], clinic_count)</span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(clinic_slopes) <span class="sc">!=</span> clinic_count) clinic_slopes <span class="ot">&lt;-</span> <span class="fu">rep</span>(clinic_slopes[<span class="dv">1</span>], clinic_count)</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(doctor_effects) <span class="sc">!=</span> doctor_count) doctor_effects <span class="ot">&lt;-</span> <span class="fu">rep</span>(doctor_effects[<span class="dv">1</span>], doctor_count)</span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(doctor_slopes) <span class="sc">!=</span> doctor_count) doctor_slopes <span class="ot">&lt;-</span> <span class="fu">rep</span>(doctor_slopes[<span class="dv">1</span>], doctor_count)</span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop to create data for each combination of clinic and doctor</span></span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (clinic <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>clinic_count) {</span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (doctor <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>doctor_count) {</span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>      x_start <span class="ot">=</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">10</span>) <span class="co"># Continuous x values</span></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>      x <span class="ot">=</span> <span class="fu">runif</span>(measurements_per_combination, <span class="at">min =</span> x_start, <span class="at">max =</span> x_start <span class="sc">+</span> <span class="dv">10</span>) <span class="co"># Continuous x for measurements</span></span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Use the specific effect and slope for the current clinic and doctor</span></span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>      clinic_effect_adj <span class="ot">=</span> clinic_effects[clinic]</span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>      clinic_slope_adj <span class="ot">=</span> clinic_slopes[clinic]</span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>      doctor_effect <span class="ot">=</span> doctor_effects[doctor]</span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>      doctor_slope <span class="ot">=</span> doctor_slopes[doctor]</span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Simulate measurements for each combination of clinic and doctor</span></span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>measurements_per_combination) {</span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Model y incorporating both global and specific slopes and effects</span></span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a>        y <span class="ot">=</span> (global_intercept <span class="sc">+</span> clinic_effect_adj <span class="sc">+</span> doctor_effect) <span class="sc">+</span></span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a>            (global_slope <span class="sc">+</span> clinic_slope_adj <span class="sc">+</span> doctor_slope) <span class="sc">*</span> x[i] <span class="sc">+</span></span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>) <span class="co"># Assuming measurement_noise_sd is constant for simplicity</span></span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Combine this measurement with the overall dataset</span></span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">=</span> <span class="fu">rbind</span>(data, <span class="fu">data.frame</span>(<span class="at">x =</span> x[i], <span class="at">y =</span> y, <span class="at">doctor =</span> doctor, <span class="at">clinic =</span> clinic))</span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>data_int_crossed<span class="ot">&lt;-</span><span class="fu">simulate_grouped_trend_crossed</span>(<span class="at">clinic_count =</span> <span class="dv">4</span>,</span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">doctor_count =</span> <span class="dv">3</span>,</span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">measurements_per_combination =</span> <span class="dv">20</span>,</span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">global_slope =</span> <span class="dv">1</span>,<span class="at">global_intercept =</span> <span class="dv">100</span>,</span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">clinic_effects =</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">20</span>,<span class="dv">40</span>,<span class="dv">60</span>),</span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">clinic_slopes=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="fl">1.5</span>,<span class="fl">0.9</span>,<span class="fl">1.1</span>),</span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a>       <span class="at">doctor_effects =</span> <span class="fu">c</span>(<span class="fl">1.3</span>,<span class="fl">1.2</span>,<span class="dv">2</span>),</span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a>      <span class="at">doctor_slopes =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">grouped trend</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">netested trend</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false" href="">crossed trend</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the data</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data_int<span class="sc">$</span>x,data_int<span class="sc">$</span>y,<span class="at">xlab=</span><span class="st">"Age"</span>,<span class="at">ylab=</span><span class="st">"Protein expression"</span>,<span class="at">col=</span>data_int<span class="sc">$</span>group,<span class="at">pch=</span><span class="fu">as.numeric</span>(data_int<span class="sc">$</span>group))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="tutorial-hac_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data_int_nested<span class="sc">$</span>x,data_int_nested<span class="sc">$</span>y,<span class="at">col=</span>data_int_nested<span class="sc">$</span>region,<span class="at">pch=</span>data_int_nested<span class="sc">$</span>clinic,<span class="at">xlab =</span> <span class="st">"Age"</span>,<span class="at">ylab =</span> <span class="st">"Protein expression"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"top"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"Region"</span>, <span class="fu">unique</span>(data_int_nested<span class="sc">$</span>region)),</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="fu">unique</span>(data_int_nested<span class="sc">$</span>region), <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">title =</span> <span class="st">"Regions"</span>,<span class="at">horiz=</span>T)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topleft"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"Clinic"</span>, <span class="fu">unique</span>(data_int_nested<span class="sc">$</span>clinic)),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch =</span> <span class="fu">unique</span>(data_int_nested<span class="sc">$</span>clinic), <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">title =</span> <span class="st">"Clinics"</span>, <span class="at">inset =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="tutorial-hac_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(data_int_crossed<span class="sc">$</span>x,data_int_crossed<span class="sc">$</span>y,<span class="at">col=</span>data_int_crossed<span class="sc">$</span>clinic,<span class="at">pch=</span>data_int_crossed<span class="sc">$</span>doctor,<span class="at">xlab =</span> <span class="st">"Age"</span>,<span class="at">ylab =</span> <span class="st">"Protein expression"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"top"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"Clinic"</span>, <span class="fu">unique</span>(data_int_crossed<span class="sc">$</span>clinic)),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="fu">unique</span>(data_int_crossed<span class="sc">$</span>clinic), <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">title =</span> <span class="st">"Clinics"</span>,<span class="at">horiz=</span>T)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topleft"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"Doctor"</span>, <span class="fu">unique</span>(data_int_crossed<span class="sc">$</span>doctor)),</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch =</span> <span class="fu">unique</span>(data_int_crossed<span class="sc">$</span>doctor), <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">title =</span> <span class="st">"Doctors"</span>, <span class="at">inset =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="tutorial-hac_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="linear-models" class="level1">
<h1>Linear models</h1>
<section id="simple-regression" class="level2">
<h2 class="anchored" data-anchor-id="simple-regression">Simple regression</h2>
<p>Let’s fit a simple regression to model the protein expression as a function of age.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit model</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">data =</span> data_int)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># print model summary</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(model))</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Call:</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="do">## lm(formula = y ~ x, data = data_int)</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="do">## Residuals:</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="do">##      Min       1Q   Median       3Q      Max </span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="do">## -14.7166  -6.2725   0.7094   5.0500  17.9565 </span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="do">## Coefficients:</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="do">##             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="do">## (Intercept) 106.6762     7.2948   14.62  &lt; 2e-16 ***</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="do">## x            -1.8836     0.4204   -4.48 6.63e-05 ***</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="do">## ---</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="do">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="do">## Residual standard error: 7.761 on 38 degrees of freedom</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="do">## Multiple R-squared:  0.3457, Adjusted R-squared:  0.3285 </span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="do">## F-statistic: 20.07 on 1 and 38 DF,  p-value: 6.627e-05</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize data and fitted model</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data_int<span class="sc">$</span>x, data_int<span class="sc">$</span>y, <span class="at">xlab=</span><span class="st">"Age"</span>, <span class="at">ylab=</span><span class="st">"Protein expression"</span>, <span class="at">main=</span><span class="st">""</span>)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(model, <span class="at">col=</span><span class="st">"red"</span>) <span class="co"># Add the regression line in red</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-lm" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-lm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="tutorial-hac_files/figure-html/fig-lm-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Scatter plot of Protein expression against Age with a fitted regression line.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpretation
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The intercept, estimated at 106.6762, represents the expected Protein expression when Age is zero. Although having an age of zero is not meaningful in this context, the intercept gives us a starting reference point for the model.</p>
<p>The slope coefficient for Age (x) is -1.8836, indicating that for each one-unit increase in Age, Protein expression is expected to decrease by approximately 1.88 units. This negative association is significant, as indicated by the p-value of 6.63e-05, which is much lower than the conventional threshold of 0.05 for statistical significance.</p>
<p>The standard error of the estimate for the slope tells us the average amount that the coefficient estimates vary from the actual average value of our response variable. Here, the standard error for the slope is 0.4204, which is relatively small compared to the estimate itself, suggesting a precise estimate of the slope. So we are pretty confident in what we have estimated. However, while the regression line provides a clear visual indication of the overall trend, it does not account for the potential clustering of data points.</p>
</div>
</div>
</div>
</section>
<section id="multiple-regression" class="level2">
<h2 class="anchored" data-anchor-id="multiple-regression">Multiple regression</h2>
<p>When we look more closely we can see four different clusters of the data. While the global pattern seems decreasing as seen above in the simple linear regression, the local pattern per cluster of data increases with Age.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the data with different colors for each group</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data_int<span class="sc">$</span>x, data_int<span class="sc">$</span>y, <span class="at">xlab=</span><span class="st">"Age"</span>, <span class="at">ylab=</span><span class="st">"Protein expression"</span>, <span class="at">main=</span><span class="st">"Linear Regression: Age vs. Protein Expression"</span>, <span class="at">col=</span>data_int<span class="sc">$</span>group)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a linear regression line</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">data =</span> data_int), <span class="at">col=</span><span class="st">"red"</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to draw ellipse</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>draw_ellipse <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, <span class="at">level =</span> <span class="fl">0.95</span>, col){</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the means of x and y</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  xbar <span class="ot">&lt;-</span> <span class="fu">mean</span>(x)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  ybar <span class="ot">&lt;-</span> <span class="fu">mean</span>(y)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the standard deviations</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  std_x <span class="ot">&lt;-</span> <span class="fu">sd</span>(x)<span class="sc">*</span><span class="dv">2</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  std_y <span class="ot">&lt;-</span> <span class="fu">sd</span>(y)<span class="sc">*</span><span class="dv">2</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the correlation</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  correlation <span class="ot">&lt;-</span> <span class="fu">cor</span>(x, y)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a sequence of angles</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">2</span><span class="sc">*</span>pi, <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the ellipse points</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  a <span class="ot">&lt;-</span> std_x <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">+</span> correlation)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">&lt;-</span> std_y <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> correlation)</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  ellipse_x <span class="ot">&lt;-</span> xbar <span class="sc">+</span> a <span class="sc">*</span> <span class="fu">cos</span>(t)</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  ellipse_y <span class="ot">&lt;-</span> ybar <span class="sc">+</span> b <span class="sc">*</span> <span class="fu">sin</span>(t)</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Draw the ellipse</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(ellipse_x, ellipse_y, <span class="at">col=</span>col, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw ellipses for each group</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>unique_groups <span class="ot">&lt;-</span> <span class="fu">unique</span>(data_int<span class="sc">$</span>group)</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">&lt;-</span> <span class="fu">rainbow</span>(<span class="fu">length</span>(unique_groups))</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (group <span class="cf">in</span> unique_groups) {</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>  group_data <span class="ot">&lt;-</span> data_int[data_int<span class="sc">$</span>group <span class="sc">==</span> group, ]</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw_ellipse</span>(group_data<span class="sc">$</span>x, group_data<span class="sc">$</span>y, <span class="at">col=</span>group)</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="tutorial-hac_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>More precisely, there is a positive trend in each of the clusters that has not been captured by the simple regression model. Instead the model focused on the global pattern. We can fit single model for each of the group to try to account for the fact that the Protein expression adn Age are correlated within each cluster. This approach may be valid especially when we do not have many groups and we have enough data in each of the groups. Let’s add Group as covariate in a multiple regression model.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a linear regression model</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>data_int<span class="sc">$</span>group <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data_int<span class="sc">$</span>group)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>model_cov <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x<span class="sc">+</span>group, <span class="at">data =</span> data_int)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(model_cov))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ x + group, data = data_int)

Residuals:
    Min      1Q  Median      3Q     Max 
-7.7577 -3.2657 -0.1872  1.4925 10.7686 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   58.798     15.341   3.833 0.000505 ***
x              2.213      1.136   1.949 0.059406 .  
group2       -23.072      3.133  -7.364 1.30e-08 ***
group3       -31.187      6.159  -5.064 1.32e-05 ***
group4       -34.509      8.716  -3.959 0.000351 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 4.625 on 35 degrees of freedom
Multiple R-squared:  0.786, Adjusted R-squared:  0.7615 
F-statistic: 32.13 on 4 and 35 DF,  p-value: 2.832e-11</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predictions</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>data_int<span class="sc">$</span>predicted <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_cov)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data_int<span class="sc">$</span>x, data_int<span class="sc">$</span>y, <span class="at">xlab=</span><span class="st">"Age"</span>, <span class="at">ylab=</span><span class="st">"Protein expression"</span>, <span class="at">pch=</span><span class="dv">19</span>, <span class="at">col=</span>data_int<span class="sc">$</span>group)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Add predicted lines</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(<span class="fu">unique</span>(data_int<span class="sc">$</span>group))){</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  group_subset <span class="ot">&lt;-</span> data_int[data_int<span class="sc">$</span>group <span class="sc">==</span> unique_groups[i], ]</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(group_subset<span class="sc">$</span>x, group_subset<span class="sc">$</span>predicted, <span class="at">col =</span> i, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-lm-multiple" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-lm-multiple-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="tutorial-hac_files/figure-html/fig-lm-multiple-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lm-multiple-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Scatter plot of Protein expression against Age with a fitted regression line for each group.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpretation
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Starting with the intercept, which is 58.798, this tells us the expected value of <code>y</code> when <code>x</code> is at 0 and when we are considering the baseline group (<code>group1</code>). It is like saying, “If we do not move <code>x</code> and if we are looking at <code>group1</code>, <code>y</code> would be around 58.798.”</p>
<p>Next, we have the coefficient for <code>x</code>, which is 2.213. This number shows how y changes with a one-unit increase in <code>x</code>, across all groups. It is an universal slope, implying that regardless of which group we are looking at, if <code>x</code> goes up by one, <code>y</code> tends to increase by about 2.213 units, holding everything else constant.</p>
<p>Now, the interesting part - the different intercepts for each group beyond the first. The coefficients for <code>group2</code> (-23.072), <code>group3</code> (-31.187), and <code>group4</code> (-34.509) adjust the baseline level of <code>y</code> for each group compared to group1. What this means is that if we are in <code>group2</code> and <code>x</code> is 0, <code>y</code> is expected to be 23.072 units lower than the baseline of group1. Similarly, for <code>group3</code> and <code>group4</code>, <code>y</code> would be 31.187 and 34.509 units lower than group1’s baseline, respectively, when <code>x</code> is 0.</p>
<p>These differences highlight that our groups have unique starting points for <code>y</code>, which are not explained by <code>x</code> alone. There are underlying characteristics or conditions specific to each group that affect <code>y</code>, independent of <code>x</code>. By including these group differences in our model, we can accurately capture the unique relationship between <code>x</code> and <code>y</code> for each group, showing that not every group begins from the same place.</p>
</div>
</div>
</div>
</section>
<section id="mulitple-regression-with-interaction" class="level2">
<h2 class="anchored" data-anchor-id="mulitple-regression-with-interaction">Mulitple regression with interaction</h2>
<p>Having explored how different groups can have unique starting points or intercepts in our model, it is natural to wonder if the relationship between x and y—our slope—might also vary across these groups. Until now, we have assumed that a one-unit increase in x has the same impact on y for all groups. But what if this is not the case? What if the effect of <code>x</code> on <code>y</code> is stronger for some groups than for others?</p>
<p>To explore this possibility, we introduce the concept of interaction terms in our model, where we can look at how the effect of <code>x</code> on <code>y</code> might change depending on the group.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a linear regression model</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>data_int<span class="sc">$</span>group <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data_int<span class="sc">$</span>group)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>model_cov <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x<span class="sc">*</span>group, <span class="at">data =</span> data_int)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(model_cov))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ x * group, data = data_int)

Residuals:
    Min      1Q  Median      3Q     Max 
-8.2809 -2.8341 -0.1584  1.6500 11.0307 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)
(Intercept)  46.9913    28.9624   1.622    0.115
x             3.0911     2.1511   1.437    0.160
group2      -18.8314    46.6833  -0.403    0.689
group3      -30.0940    53.5919  -0.562    0.578
group4       24.0594    58.6931   0.410    0.685
x:group2     -0.3905     3.1914  -0.122    0.903
x:group3     -0.3006     3.2446  -0.093    0.927
x:group4     -3.1154     3.2539  -0.957    0.346

Residual standard error: 4.755 on 32 degrees of freedom
Multiple R-squared:  0.7931,    Adjusted R-squared:  0.7479 
F-statistic: 17.53 on 7 and 32 DF,  p-value: 2.613e-09</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predictions</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>data_int<span class="sc">$</span>predicted <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_cov)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data_int<span class="sc">$</span>x, data_int<span class="sc">$</span>y, <span class="at">xlab=</span><span class="st">"Age"</span>, <span class="at">ylab=</span><span class="st">"Protein expression"</span>, <span class="at">main=</span><span class="st">"Linear Regression: Age vs. Protein Expression"</span>, <span class="at">pch=</span><span class="dv">19</span>, <span class="at">col=</span>data_int<span class="sc">$</span>group)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Add predicted lines</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(<span class="fu">unique</span>(data_int<span class="sc">$</span>group))){</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  group_subset <span class="ot">&lt;-</span> data_int[data_int<span class="sc">$</span>group <span class="sc">==</span> unique_groups[i], ]</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(group_subset<span class="sc">$</span>x, group_subset<span class="sc">$</span>predicted, <span class="at">col =</span> i, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-lm-multiple-interaction" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-lm-multiple-interaction-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="tutorial-hac_files/figure-html/fig-lm-multiple-interaction-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lm-multiple-interaction-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Scatter plot of Protein expression against Age with a fitted regression line for each group, showing the interaction between Age and Group.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpretation
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This model allows <code>x</code> to have a different slope for each group, providing a richer understanding of our data. It is a step towards uncovering more complex patterns and interactions that might exist, shedding light on the nuanced ways in which our variables interplay. This model allows <code>x</code> to have a different slope for each group, providing a richer understanding of our data. It’s a step towards uncovering more complex patterns and interactions that might exist, shedding light on the nuanced ways in which our variables interplay.</p>
<p>The interaction terms in our new model <code>model_cov &lt;- lm(y ~ x*group, data = data_int)</code> reveal yet another layer of complexity. Now, not only do we recognize that each group starts at a different point, but we also see that the relationship between <code>x</code> and <code>y</code>—how <code>y</code> changes as <code>x</code> increases—is not a one-size-fits-all across the groups.</p>
<p>Now, let’s interpret the coefficients:</p>
<ol type="1">
<li><p><strong>(Intercept) 46.9913</strong>: This is the expected protein expression when age is zero for the baseline group (<code>group1</code>).</p></li>
<li><p><strong>x 3.0911</strong>: This coefficient represents the slope of the line for the baseline group. For each additional year of age, the protein expression is expected to increase by 3.0911 units for <code>group1</code>.</p></li>
<li><p><strong>group2 -18.8314</strong>: This coefficient adjusts the intercept for <code>group2</code>. So, the expected starting point for protein expression in <code>group2</code>, when age is zero, is 46.9913 (the baseline intercept) minus 18.8314, giving us a starting point of 28.1599.</p></li>
<li><p><strong>group3 -30.0940</strong>: Similarly, for <code>group3</code>, the expected starting point for protein expression when age is zero is 46.9913 minus 30.0940, resulting in 16.8973.</p></li>
<li><p><strong>group4 24.0594</strong>: For <code>group4</code>, the expected starting point is 46.9913 plus 24.0594, which is 71.0507, indicating that group4 has a higher starting point than group1.</p></li>
<li><p><strong>x:group2 -0.3905</strong>: This is the interaction term for age and <code>group2</code>, indicating how the slope for <code>group2</code> differs from the baseline group’s slope. The slope for <code>group2</code> is 3.0911 (baseline slope) minus 0.3905, which is approximately 2.7006. This suggests that for <code>group2</code>, for each additional year of age, the protein expression increases by about 2.7006 units, which is less than the increase for <code>group1</code>.</p></li>
<li><p><strong>x:group3 -0.3006</strong>: For <code>group3</code>, the slope is 3.0911 minus 0.3006, approximately 2.7905. So the rate of increase in protein expression per year of age for <code>group3</code> is slightly less than for <code>group1</code> but not as much less as for <code>group2</code>.</p></li>
<li><p><strong>x:group4 -3.1154</strong>: This interaction term indicates a significant change in the slope for <code>group4</code> compared to group1. The slope for <code>group4</code> is 3.0911 minus 3.1154, which is approximately -0.0243. This would suggest a slight decrease in protein expression with age for <code>group4</code>, which is contrary to the positive association seen in the other groups.</p></li>
</ol>
<p>The interaction terms, specifically the coefficients for <code>x:group2</code>, <code>x:group3</code>, and <code>x:group4</code>, tell us just how much the slope of the relationship between <code>x</code> and <code>y</code> differs for each group compared to our baseline group1. For example, group2 has a slightly lesser slope than group1, indicating that as <code>x</code> increases, <code>y</code> increases but not as rapidly as in group1. Group3 follows a similar pattern, albeit the difference is more modest.</p>
<p>Most intriguing is group4, where the interaction term is quite pronounced, suggesting that the increase in <code>y</code> with <code>x</code> is significantly less for group4 compared to <code>group1</code> in fact, it’s almost negligible, indicating a nearly flat line. This could mean that for individuals in <code>group4</code>, changes in <code>x</code> do not translate into changes in <code>y</code> as they do for the other groups.</p>
<p>What we just saw was a simple example of how to handle clustered data in a simple linear regression. Without accounting for these cluster-related differences, the assumption of independence among observations—a cornerstone of linear regression—is violated, as the outcome within a cluster are inherently correlated. This correlation persists even when attempting to control for the cluster’s effect, due to other unobservable factors.</p>
<p>The consequence of ignoring cluster-level effects might lead to incorrect inferences, as standard errors are usually underestimated, making them appear more precise than they actually are. While the regression coefficients themselves might remain unbiased, the underestimation of standard errors can falsely enhance the significance of findings. Furthermore, we often ten to overestimate the degrees of freedom leading to inflated p-values.</p>
<p>Addressing this issue often involves introducing indicator variables (similar to what we have done above) to account for cluster effects, allowing for different intercepts or even slope for each cluster. However, this approach becomes impractical with a large number of clusters or when dealing with longitudinal data. Furthermore, we might not even be interested in modeling clusters parameters, we are just interested in some specific questions. Think about the simple dataset we just analyzed, the main effect of interest was <code>Age</code>, however, we had to estimate a lot more parameters in the model to account for the cluster effect. More specifically, in <code>lm(y~x+group)</code> we estimate <em>five</em> parameters and in <code>lm(y~x*group,data_int)</code> we had <em>eight</em> parameters while we basically needed <em>two</em>. These parameters are all degrees of freedom that we spend while we might not even be interested in the cluster level parameters. Now imagine we might have hundreds of nested clustered with limited data, such modeling attempt will quickly become unfeasible and may lead to overfitting. In such cases, the model would consume degrees of freedom excessively, reducing the power of statistical tests and potentially leading to unreliable estimates due to the curse of dimensionality. Moreover, with a high number of parameters relative to the number of observations, standard errors of the estimates increase, which can make the model’s predictions less precise.</p>
<p>To address these issues, we often resort to mixed-effects models.</p>
</div>
</div>
</div>
</section>
</section>
<section id="linear-mixed-models" class="level1">
<h1>Linear mixed models</h1>
<section id="random-intercept" class="level2">
<h2 class="anchored" data-anchor-id="random-intercept">Random intercept</h2>
<p>Now it is time to use mixed model approach to model Protein expression. Let’s say that each group is a random clinic that we decided to get some sample from. So we now have identified the grouping structure in our data that might influence the effect of interest (Age).</p>
<p>What we believe is that the effect of Age on the Protein expression is constant in each of the groups. However, due to either technical issues with the instruments or even demographics, each group might have different baselines (starting point) for the protein expression. This gives us a hint that we might have to model <code>intercept</code> differently for each group. In addition we would like to know how much differences exactly are between each of these clinics. Therefore I want to use fixed effect to exactly pinpoint the estimated baseline for each of the clinic and compare them against each other.</p>
<p>You may argue that there is no reason to do that. We just picked a few random clinics, there is no point in knowing by how much clinic 1 is different to clinic 2 because we could have selected and other random clinics in the world. So let’s model this as random effect to get the variance of the intercepts across clinics. By modeling the intercept as a random effect, we acknowledge that each clinic has its own baseline level of protein expression due to various unmeasured factors such as technical differences in equipment or demographic variations. This approach allows us to account for the inherent variability between clinics without focusing on the specific differences between any two clinics. Instead, we aim to understand the general variability of baseline protein expression levels across clinics.</p>
<p>We start by allowing for a random intercept in the groups. The model that we are going fit using <code>lmer</code> function from <code>lme4</code> is of form <code>y ~ 1+x+(1|group)</code>. This part of the model, <code>y ~ 1+x</code>, we already know what it is. However, what this part <code>(1|group)</code> is new. The right part of <code>|</code> shows what variable we want to use as grouping factor by which we are going to fit our random effect (That is the <code>group</code> in our case). The left part of <code>|</code> is the effect we want to consider random. The left part is like a formula, similar to classical regression. which in this case, we just used <code>1</code>. This means for our main model, <code>y ~ 1+x</code> which has an intercept (<code>1</code>) and a slope <code>x</code>, we would like to consider the intercept as random effect so we use <code>1</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a mixed linear regression model</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>model_lmm <span class="ot">&lt;-</span> <span class="fu">lmer</span>(y <span class="sc">~</span> <span class="dv">1</span><span class="sc">+</span>x<span class="sc">+</span>(<span class="dv">1</span><span class="sc">|</span>group), <span class="at">data =</span> data_int)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(model_lmm))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ 1 + x + (1 | group)
   Data: data_int

REML criterion at convergence: 244.6

Scaled residuals: 
     Min       1Q   Median       3Q      Max 
-1.73343 -0.61480 -0.00871  0.37734  2.22117 

Random effects:
 Groups   Name        Variance Std.Dev.
 group    (Intercept) 184.10   13.568  
 Residual              21.57    4.645  
Number of obs: 40, groups:  group, 4

Fixed effects:
            Estimate Std. Error t value
(Intercept)   50.205     18.893   2.657
x              1.418      1.030   1.377

Correlation of Fixed Effects:
  (Intr)
x -0.932</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpretation
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Under <strong>Fixed effects</strong> output we see a single intercept and a single slope. These are <code>global</code> trends in the data with their corresponding <code>Std. Error</code> and <code>t value</code>. Under <strong>Random effects</strong> output we see <code>Random effects</code> of the model.</p>
<p>Depending of what type of random effect we have been fitting this table can have different headers. But generally, <code>Groups</code>, <code>Name</code>, <code>Variance</code>, <code>Std.Dev.</code> and <code>Corr</code> are part of it.</p>
<p>Each row of this table correspond to a source of variation in our data that is random because of a certain reason. In our model, we decided to consider only <code>Intercept</code> as a random effect for <code>group</code>. Therefore, the first row of the table tells us that there is <strong>random</strong> variability in <code>Intercept</code> between different group. This variability is quantified by a variance of 184.101 and a standard deviation of 13.568. This means that the average effect (or intercept) across groups can deviate from the overall (<code>global</code>) intercept by about 13.568 units, indicating substantial between-group variability. This is important to note that, we have actually never estimated any intercept for each group directly. But we have estimated the variability of intercepts across different groups, which allows us to account for the fact that each group may have a different starting point or baseline level in the response variable, even though these specific baseline levels are not directly calculated. You can think about this as the variance of the distribution of intercepts across the groups. Essentially, we’re modeling the distribution from which each group’s intercept is drawn.</p>
<p>The second row, labeled <code>Residual</code>, refers to the variability within each group that is not explained by the model predictors (because of random sampling). The variance here is 21.574, with a standard deviation of 4.645. This residual variance represents the individual differences or noise within groups after accounting for the modeled effects, including the random intercepts.</p>
<p>In summary, we used mixed models with a <strong>random intercept</strong> to model the effect of age on protein expression. We got an estimated global intercept (baseline) and slope (main effect of interest). We took care of the grouping structure of our data without directly estimating any additional parameters. In fact, what we estimated was <code>intercept</code>, <code>slope</code>, <code>variance of Intercept</code> and <code>variance of residuals</code>. One of the coolest thing here is that we would have estimated the exact same number of parameters if our grouping structure had a lot more levels. But if we want to use grouping as covariate (in a classic model), we should have modeled all of those levels!</p>
</div>
</div>
</div>
<section id="predicting-the-random-intercept" class="level3">
<h3 class="anchored" data-anchor-id="predicting-the-random-intercept">Predicting the random intercept</h3>
<p>Despite that we have not estimated the intercept for each of the group, we can still predict what would the intercept be for each of the groups. In R we can use <code>ranef()</code> function from <code>lme4</code> package and mathematical details are described under the Mathematical Details section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">ranef</span>(model_lmm))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$group
  (Intercept)
1   19.059412
2   -2.116552
3   -7.752078
4   -9.190783

with conditional variances for "group" </code></pre>
</div>
</div>
<p>In this particular case, it gave us the differences from the overall intercept estimated in the mixed effects model. By extracting the random effects using the <code>ranef</code> function, we obtain the specific adjustments needed for each group. We can now use the global intercept and these adjustments to visualize the predicted intercept.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the initial scatter plot with points colored by group and shape determined by group</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data_int<span class="sc">$</span>x, data_int<span class="sc">$</span>y, <span class="at">xlab=</span><span class="st">"Age"</span>, <span class="at">ylab=</span><span class="st">"Protein expression"</span>,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">col=</span>data_int<span class="sc">$</span>group, <span class="at">pch=</span><span class="fu">as.numeric</span>(data_int<span class="sc">$</span>group))</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Looping through each unique group in the dataset</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (group <span class="cf">in</span> <span class="fu">unique</span>(data_int<span class="sc">$</span>group)) {</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset data for the current group</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  group_data <span class="ot">&lt;-</span> data_int[data_int<span class="sc">$</span>group <span class="sc">==</span> group,]</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the intercept for the group by adding the fixed intercept to the group's random effect</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  intercept <span class="ot">&lt;-</span> <span class="fu">fixef</span>(model_lmm)[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">ranef</span>(model_lmm)[[<span class="dv">1</span>]][group, <span class="dv">1</span>]</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the fixed effect slope from the model</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  slope <span class="ot">&lt;-</span> <span class="fu">fixef</span>(model_lmm)[<span class="dv">2</span>]</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Draw a line for the group using the calculated intercept and slope</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="at">y =</span> intercept <span class="sc">+</span> slope <span class="sc">*</span> group_data<span class="sc">$</span>x, <span class="at">x =</span> group_data<span class="sc">$</span>x, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Draw a global effect line using the fixed effect intercept and slope from the model</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">a =</span> <span class="fu">fixef</span>(model_lmm)[<span class="dv">1</span>], <span class="at">b =</span> <span class="fu">fixef</span>(model_lmm)[<span class="dv">2</span>], <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Adding a legend to the plot</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>legend_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Global Effect"</span>, <span class="st">"Random Intercept"</span>)</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> legend_labels, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>), <span class="at">lty =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="tutorial-hac_files/figure-html/fig-scatter-plot-grouped-lmm-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Scatter plot of Age vs.&nbsp;Protein expression per group with random intercept
</figcaption>
</figure>
</div>
</div>
</div>
<p>Here we have plotted best unbiased estimated trend per group and also the global trend. We can see that all the lines are parallel (as we still did not model slope per group) and there is a deviation of slope in each of the groups compared to the global trend.</p>
<p>Looking at <a href="#fig-scatter-plot-grouped-lmm" class="quarto-xref">Figure&nbsp;4</a>, we can see that a lot of variation is because of the differences between the groups. This is exactly what the variance component of the mixed model showed us. The ratio of random intercept and the total variance quantifies how much of the total variability in the outcome is due to variability between groups: <span class="math inline">\(\frac{184.101}{21.574+184.101}=89.51\%\)</span>. So most of the variation in the data is because of the differences between the groups.</p>
</section>
</section>
<section id="random-slope" class="level2">
<h2 class="anchored" data-anchor-id="random-slope">Random slope</h2>
<p>In addition to the random intercept, we may argue that the effect of age on protein expression might not be uniform across all clinics. This variability suggests that we should also consider modeling the slope as a random effect, allowing the relationship between age and protein expression to vary among the groups. This leads us to a more complex but potentially more accurate model: <code>y ~ 1+x+(1+x|group)</code>. In this model, not only the intercepts are allowed to vary randomly across clinics (<code>1</code> part of the the model), but also the slopes (<code>x</code>). This basically says that each clinic might not only have a different starting point of protein expression but also a different rate at which protein expression changes with age.</p>
<p>Implementing a random slope model accommodates the hypothesis that the effect of age could be influenced by factors specific to each clinic, such as demographic characteristics, environmental factors, or other clinic-specific variables not captured in the dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit a mixed linear regression model with random slopes</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>model_lmm_rs <span class="ot">&lt;-</span> <span class="fu">lmer</span>(y <span class="sc">~</span> <span class="dv">1</span><span class="sc">+</span>x<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>x<span class="sc">|</span>group), <span class="at">data =</span> data_int)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(model_lmm_rs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ 1 + x + (1 + x | group)
   Data: data_int

REML criterion at convergence: 244.6

Scaled residuals: 
     Min       1Q   Median       3Q      Max 
-1.73945 -0.60089  0.01584  0.37888  2.22089 

Random effects:
 Groups   Name        Variance  Std.Dev. Corr
 group    (Intercept) 111.34446 10.5520      
          x             0.04199  0.2049  1.00
 Residual              21.43270  4.6295      
Number of obs: 40, groups:  group, 4

Fixed effects:
            Estimate Std. Error t value
(Intercept)   49.833     18.287   2.725
x              1.464      1.035   1.415

Correlation of Fixed Effects:
  (Intr)
x -0.923</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the initial scatter plot with points colored by group and shape determined by group</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data_int<span class="sc">$</span>x, data_int<span class="sc">$</span>y, <span class="at">xlab=</span><span class="st">"Age"</span>, <span class="at">ylab=</span><span class="st">"Protein expression"</span>,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">col=</span>data_int<span class="sc">$</span>group, <span class="at">pch=</span><span class="fu">as.numeric</span>(data_int<span class="sc">$</span>group))</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Looping through each unique group in the dataset</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (group <span class="cf">in</span> <span class="fu">unique</span>(data_int<span class="sc">$</span>group)) {</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset data for the current group</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  group_data <span class="ot">&lt;-</span> data_int[data_int<span class="sc">$</span>group <span class="sc">==</span> group,]</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the intercept for the group by adding the fixed intercept to the group's random effect</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  intercept <span class="ot">&lt;-</span> <span class="fu">fixef</span>(model_lmm_rs)[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">ranef</span>(model_lmm_rs)[[<span class="dv">1</span>]][group, <span class="dv">1</span>]</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the fixed effect slope from the model</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  slope <span class="ot">&lt;-</span> <span class="fu">fixef</span>(model_lmm_rs)[<span class="dv">2</span>]<span class="sc">+</span><span class="fu">ranef</span>(model_lmm_rs)[[<span class="dv">1</span>]][group, <span class="dv">2</span>]</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Draw a line for the group using the calculated intercept and slope</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="at">y =</span> intercept <span class="sc">+</span> slope <span class="sc">*</span> group_data<span class="sc">$</span>x, <span class="at">x =</span> group_data<span class="sc">$</span>x, <span class="at">col =</span> <span class="st">"green"</span>, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  intercept <span class="ot">&lt;-</span> <span class="fu">fixef</span>(model_lmm)[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">ranef</span>(model_lmm)[[<span class="dv">1</span>]][group, <span class="dv">1</span>]</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the fixed effect slope from the model</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  slope <span class="ot">&lt;-</span> <span class="fu">fixef</span>(model_lmm)[<span class="dv">2</span>]</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="at">y =</span> intercept <span class="sc">+</span> slope <span class="sc">*</span> group_data<span class="sc">$</span>x, <span class="at">x =</span> group_data<span class="sc">$</span>x, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Draw a global effect line using the fixed effect intercept and slope from the model</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">a =</span> <span class="fu">fixef</span>(model_lmm_rs)[<span class="dv">1</span>], <span class="at">b =</span> <span class="fu">fixef</span>(model_lmm_rs)[<span class="dv">2</span>], <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Adding a legend to the plot</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>legend_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Global Effect"</span>, <span class="st">"Random Intercept"</span>, <span class="st">"Random Intercep and slope"</span>)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> legend_labels, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>,<span class="st">"green"</span>), <span class="at">lty =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm-rs" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-rs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="tutorial-hac_files/figure-html/fig-scatter-plot-grouped-lmm-rs-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-rs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Scatter plot of Age vs.&nbsp;Protein expression per group with random intercept and slope
</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpretation
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>In the output, we see not just the variance and standard deviation for the intercepts across groups, but also for the slopes. This allows us to quantify how much variation there is in the relationship between age and protein expression across the different clinics.</p>
<p>Looking at fixed effect, we still have the global intercept and slope. There is a small change compared to the previous model but the major change now is in the random effect part. The <code>Random effects</code> section of the model summary now includes information about the variability in slopes in addition to the intercepts.</p>
<p>We still have the major source of variation in our data caused by <code>Intercept</code> and a smaller, but still present, variability in how age affects protein expression across these clinics (the slope <code>x</code>).</p>
<p>A high correlation between the intercept and slope within the random effects suggests a linear relationship in the random part of the model. This indicates that clinics with higher baseline protein expression also have a stronger positive relationship between age and protein expression.</p>
<p>The plot above illustrates the variability in protein expression as a function of age across different clinics. The blue line indicates the overall trend across all clinics (Global Effect), while the red and green lines represent individual clinic trends. The red lines show the clinic-specific adjustments to the overall intercept (Random Intercept), indicating that some clinics, on average, have higher or lower protein expression regardless of age. The green lines show both clinic-specific intercepts and slopes (Random Intercept and Slope), suggesting that the rate at which protein expression changes with age also varies by clinic. This visual representation underscores the importance of accounting for random effects in the model, as it captures the ways in which age influences protein expression across diverse clinical settings.</p>
<p>In this specific case, the global estimated intercept and slope did not change that much compared to the random intercept model. However, in the cases that there is a very large deviation between slopes of different groups, the global coefficient can be much more impacted.</p>
</div>
</div>
</div>
</section>
<section id="nested-design" class="level2">
<h2 class="anchored" data-anchor-id="nested-design">Nested design</h2>
<p>In nested designs, the analysis aims to account for the variability at each level of the hierarchy. For example, when assessing the effect of age on protein expression, a nested model allows for the separation of the variability attributable to differences between regions, differences between clinics within regions, and individual differences between patients within clinic. This separation is crucial for accurately estimating the effects of interest (e.g., age) while controlling for the hierarchical structure of the data.</p>
<p>Let’s consider a simulated nested data:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>data_int_nested<span class="ot">&lt;-</span><span class="fu">simulate_grouped_trend_nested</span>(<span class="at">region_count =</span> <span class="dv">4</span>,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">clinics_per_region =</span> <span class="dv">3</span>,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">measurements_per_clinic =</span> <span class="dv">20</span>,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">global_slope =</span> <span class="dv">0</span>,<span class="at">global_intercept =</span> <span class="dv">100</span>,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">region_effects =</span> <span class="fu">rnorm</span>(<span class="dv">4</span>,<span class="at">mean =</span> <span class="dv">0</span>,<span class="at">sd =</span> <span class="dv">20</span>),</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">region_slopes=</span><span class="fu">rnorm</span>(<span class="dv">4</span>,<span class="at">mean =</span> <span class="fl">0.1</span>,<span class="at">sd =</span> <span class="dv">2</span>),</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">clinic_effects =</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,<span class="cf">function</span>(i){<span class="fu">rnorm</span>(<span class="dv">3</span>,<span class="at">mean =</span> <span class="dv">0</span>,<span class="at">sd =</span> <span class="dv">10</span>)}),</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">clinic_slopes =</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,<span class="cf">function</span>(i){<span class="fu">rnorm</span>(<span class="dv">3</span>,<span class="at">mean =</span> <span class="fl">0.1</span>,<span class="at">sd =</span> <span class="dv">1</span>)}))</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data_int_nested<span class="sc">$</span>x,data_int_nested<span class="sc">$</span>y,<span class="at">col=</span>data_int_nested<span class="sc">$</span>region,<span class="at">pch=</span>data_int_nested<span class="sc">$</span>clinic,<span class="at">xlab =</span> <span class="st">"Age"</span>,<span class="at">ylab =</span> <span class="st">"Protein expression"</span>)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"top"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"Region"</span>, <span class="fu">unique</span>(data_int_nested<span class="sc">$</span>region)),</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="fu">unique</span>(data_int_nested<span class="sc">$</span>region), <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">title =</span> <span class="st">"Regions"</span>,<span class="at">horiz=</span>T)</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topleft"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"Clinic"</span>, <span class="fu">unique</span>(data_int_nested<span class="sc">$</span>clinic)),</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch =</span> <span class="fu">unique</span>(data_int_nested<span class="sc">$</span>clinic), <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">title =</span> <span class="st">"Clinics"</span>, <span class="at">inset =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm-nested" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-nested-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="tutorial-hac_files/figure-html/fig-scatter-plot-grouped-lmm-nested-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-nested-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Scatter plot of Age vs.&nbsp;Protein expression for nested design
</figcaption>
</figure>
</div>
</div>
</div>
<p>where a single sample was from a single clinic and a single clinic was from one and only one region. Looking at <a href="#fig-scatter-plot-grouped-lmm-nested" class="quarto-xref">Figure&nbsp;6</a>, we can already see that there is a very big baseline difference between regions. Within each region, there is also some baseline differences between clinics but it is less dominant than the region differences. Furthermore, the effect of Age on Protein expression seems to be different slightly across different regions (some have positive effect, some negative and some close to zero) and to a lesser extend within each region but across clinics.</p>
<p>To model this data we consdier both the intercept and slope as random effects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit model</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>model_lmm_nested <span class="ot">&lt;-</span> <span class="fu">lmer</span>(y<span class="sc">~</span>x<span class="sc">+</span>(x<span class="sc">|</span>region<span class="sc">/</span>clinic), data_int_nested)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(model_lmm_nested))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ x + (x | region/clinic)
   Data: data_int_nested

REML criterion at convergence: 859.5

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-3.2078 -0.6721  0.0060  0.6872  2.2319 

Random effects:
 Groups        Name        Variance Std.Dev. Corr 
 clinic:region (Intercept)  66.006   8.124        
               x             1.218   1.104   -0.31
 region        (Intercept) 384.553  19.610        
               x             6.615   2.572   -0.25
 Residual                    1.085   1.042        
Number of obs: 240, groups:  clinic:region, 12; region, 4

Fixed effects:
            Estimate Std. Error t value
(Intercept)  100.915     10.096   9.996
x              0.337      1.325   0.254

Correlation of Fixed Effects:
  (Intr)
x -0.255</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpretation
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This result is slightly different to what we have seen before using only a single grouping factor. Now we have <strong>clinic within region (clinic:region)</strong> in which the model estimates random intercepts and slopes for clinics nested within regions. This reflects the variability in baseline Protein expression and the effect of Age on Protein expression at the clinic level, indicating that clinics within the same region may still exhibit unique characteristics. The model also estimates random intercepts and slopes at the <strong>region</strong> level, capturing broader variations across regions. This indicates how different regions can have distinct baseline Protein expressions and different relationships between Age and Protein expression.</p>
<p>The model identifies significant variability in baseline Protein expression levels across regions, as indicated by the standard deviation of the intercepts for regions. This variability signifies that different regions start off with different baseline Protein expressions. There’s additional variability at the clinic level within each region, though this effect is smaller compared to the variability between regions.</p>
<p>The slopes, representing the effect of Age on Protein expression, also vary by region and by clinic within regions. This variation in slopes indicates that the relationship between Age and Protein expression is not uniform; it changes from one region to another and even among clinics within the same region. Some regions or clinics might show a positive relationship (increasing Age associated with higher Protein expression), while others show a negative or negligible relationship.</p>
<p>Similar to what we have seen before, the model provides a correlation coefficient between the intercept and slope within clinics nested in regions. A negative correlation suggests that clinics with higher baseline Protein expression tend to have a less steep (or more negative) Age effect, or vice versa.</p>
<p>Finally, the fixed effect intercept represents the average baseline level of Protein expression when Age is zero, pooled across all regions and clinics. This gives a general starting point for Protein expression across the dataset. And the fixed effect slope indicates the average effect of Age on Protein expression, again pooled across the entire dataset. This effect sizes up the general tendency of how Protein expression changes with Age, irrespective of the region or clinic.</p>
</div>
</div>
</div>
</section>
<section id="crossed-design" class="level2">
<h2 class="anchored" data-anchor-id="crossed-design">Crossed design</h2>
<p>Consider a hypothetical study to explore the effects of Age on Protein expression within a single patient with crossed design, where patients visits multiple doctors across various clinics at different ages. Recognizing the potential for variability introduced by the differing methodologies and environments inherent to each clinic, as well as the distinct clinical approaches of each doctor. Specifically, we want to analyze the data, treating age as a continuous fixed effect to investigate its influence on protein expression. Concurrently, we model doctors and clinics as random effects to account for the variability they introduce into the protein expression measurements. This allows us not only to assess the general trend of protein expression changes over time but also to explore how these changes might be modulated differently across the various clinical settings and by different medical professionals.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>data_int_crossed<span class="ot">&lt;-</span><span class="fu">simulate_grouped_trend_crossed</span>(<span class="at">clinic_count =</span> <span class="dv">4</span>,</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">doctor_count =</span> <span class="dv">3</span>,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">measurements_per_combination =</span> <span class="dv">20</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">global_slope =</span> <span class="dv">1</span>,<span class="at">global_intercept =</span> <span class="dv">100</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">clinic_effects =</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">20</span>,<span class="dv">40</span>,<span class="dv">60</span>),</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">clinic_slopes=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="fl">1.5</span>,<span class="fl">0.9</span>,<span class="fl">1.1</span>),</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">doctor_effects =</span> <span class="fu">c</span>(<span class="fl">1.3</span>,<span class="fl">1.2</span>,<span class="dv">2</span>),</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">doctor_slopes =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(data_int_crossed<span class="sc">$</span>x,data_int_crossed<span class="sc">$</span>y,<span class="at">col=</span>data_int_crossed<span class="sc">$</span>clinic,<span class="at">pch=</span>data_int_crossed<span class="sc">$</span>doctor,<span class="at">xlab =</span> <span class="st">"Age"</span>,<span class="at">ylab =</span> <span class="st">"Protein expression"</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"top"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"Clinic"</span>, <span class="fu">unique</span>(data_int_crossed<span class="sc">$</span>clinic)),</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="fu">unique</span>(data_int_crossed<span class="sc">$</span>clinic), <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">title =</span> <span class="st">"Clinics"</span>,<span class="at">horiz=</span>T)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topleft"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"Doctor"</span>, <span class="fu">unique</span>(data_int_crossed<span class="sc">$</span>doctor)),</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch =</span> <span class="fu">unique</span>(data_int_crossed<span class="sc">$</span>doctor), <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">title =</span> <span class="st">"Doctors"</span>, <span class="at">inset =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm-crossed" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-crossed-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="tutorial-hac_files/figure-html/fig-scatter-plot-grouped-lmm-crossed-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-crossed-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Scatter plot of Age vs.&nbsp;Protein expression for crossed design
</figcaption>
</figure>
</div>
</div>
</div>
<p>Ok! Now it is a bit more complicated that before. What <a href="#fig-scatter-plot-grouped-lmm-crossed" class="quarto-xref">Figure&nbsp;7</a> tells us is that there appears to be quite a big differences in baseline between different clinics (colors). The effect of age on protein expression seems to be consistently go up in each clinic. However, looking at the doctors (shapes), we see that all three of them are quite consistent when it comes to baseline but one of them has a big slope differences compare to the other two.</p>
<p>To model this data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>model_lmm_crossed <span class="ot">&lt;-</span> <span class="fu">lmer</span>(y<span class="sc">~</span>x<span class="sc">+</span>(x<span class="sc">|</span>clinic)<span class="sc">+</span>(x<span class="sc">|</span>doctor),data_int_crossed)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(model_lmm_crossed))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ x + (x | clinic) + (x | doctor)
   Data: data_int_crossed

REML criterion at convergence: 732.3

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-2.6591 -0.6855 -0.0931  0.6247  3.4435 

Random effects:
 Groups   Name        Variance  Std.Dev. Corr 
 clinic   (Intercept) 651.16132 25.5179       
          x             0.05924  0.2434  -0.17
 doctor   (Intercept)   0.19892  0.4460       
          x             6.93394  2.6332  0.82 
 Residual               0.91374  0.9559       
Number of obs: 240, groups:  clinic, 4; doctor, 3

Fixed effects:
            Estimate Std. Error t value
(Intercept)  131.832     12.763  10.329
x              2.108      1.525   1.382

Correlation of Fixed Effects:
  (Intr)
x 0.003 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpretation
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The interpretation is the same as before, we have three kind of variations in both slopes and intercept. Between doctors, between clinics and of course the residuals. The largest variance is between the clinics in their baseline followed by the slope of doctors.</p>
<p>That of more or less what the crossed design looks like. It is important to note that, you <strong>should not</strong> model the crossed designs using the nested formula. Using a nested random effects notation like <code>(x | clinic:doctor)</code> implies a nested structure where each “doctor” is considered to be unique within each “clinic” and does not account for the possibility of the same doctor working across multiple clinics. This notation inherently assumes that each doctor-clinic combination is distinct and treats “doctor” identities as separate within each clinic, without recognizing that a single doctor could contribute data across different clinics. Modeling crossed factors using nested notation can inadvertently obscure the independence of those factors and the data’s true structure. As a result, it introduces structural biases in the analysis, potentially leading to incorrect conclusions about the effects of interest and the variability within and across the groups.</p>
<p>So to summarize, the crossed design does not assume any particular relationship between region and clinic. They are just two separate sources of random variability. This could be appropriate in a design where doctors from the same clinic could be more similar to each other, but a doctor could theoretically belong to any clinic.</p>
<p>The nested design assumes that doctors are nested within clinics. This introduces additional structure to the random effects, where the variability at the doctor level is specific to each clinic. This model is used in designs, where the data from doctors are grouped by clinics, and you expect that doctors within the same clinic share some commonality that is different from doctors in other clinics.</p>
</div>
</div>
</div>
</section>
<section id="models-with-interaction" class="level2">
<h2 class="anchored" data-anchor-id="models-with-interaction">Models with interaction</h2>
<p>In this example, our aim is to explore how the effectiveness of various treatments may vary with changes in dosage, and whether these effects are consistent across different doctors.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>simulatePatientData <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">numDoctors =</span> <span class="dv">30</span>, <span class="at">numPatients =</span> <span class="dv">10</span>,doctor_dosage,doctor_var, <span class="at">seed =</span> <span class="dv">12345</span>) {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parameters</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  intercept <span class="ot">=</span> <span class="dv">50</span>  <span class="co"># Baseline recovery time</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  treatmentEffect <span class="ot">=</span> <span class="fu">c</span>(<span class="at">A =</span> <span class="dv">0</span>, <span class="at">B =</span> <span class="sc">-</span><span class="dv">50</span>, <span class="at">C =</span> <span class="sc">-</span><span class="dv">20</span>)  <span class="co"># Treatment effect on recovery time</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  dosageEffect <span class="ot">=</span> <span class="fu">c</span>(<span class="at">A =</span> <span class="dv">3</span>, <span class="at">B =</span> <span class="sc">-</span><span class="dv">2</span>, <span class="at">C =</span> <span class="dv">1</span>) <span class="co"># Effect of dosage on recovery time</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simulate data</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  doctors <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>numDoctors, <span class="at">each =</span> numPatients)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  treatment <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>), <span class="at">size =</span> numDoctors <span class="sc">*</span> numPatients, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  dosage <span class="ot">&lt;-</span> <span class="fu">runif</span>(numDoctors <span class="sc">*</span> numPatients, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">10</span>)  <span class="co"># Dosage levels between 1 and 10</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  dosageEffect<span class="ot">&lt;-</span><span class="fu">rep</span>(dosageEffect,<span class="at">each=</span>numPatients)</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Random effects for doctors</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  doctorIntercept <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(numDoctors, <span class="dv">0</span>, <span class="dv">2</span>)  <span class="co"># Variation in doctor baseline recovery times</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate recovery time</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>  tr<span class="ot">&lt;-</span>treatmentEffect[treatment]</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">unique</span>(doctors))</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>   {</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>     tr[treatment<span class="sc">==</span><span class="st">"A"</span> <span class="sc">&amp;</span> doctors<span class="sc">==</span>i]<span class="ot">&lt;-</span>tr[treatment<span class="sc">==</span><span class="st">"A"</span> <span class="sc">&amp;</span>doctors<span class="sc">==</span>i]<span class="sc">+</span>doctor_var[[i]][<span class="dv">1</span>]</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>     tr[treatment<span class="sc">==</span><span class="st">"B"</span> <span class="sc">&amp;</span> doctors<span class="sc">==</span>i]<span class="ot">&lt;-</span>tr[treatment<span class="sc">==</span><span class="st">"B"</span> <span class="sc">&amp;</span>doctors<span class="sc">==</span>i]<span class="sc">+</span>doctor_var[[i]][<span class="dv">2</span>]</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>     tr[treatment<span class="sc">==</span><span class="st">"C"</span> <span class="sc">&amp;</span> doctors<span class="sc">==</span>i]<span class="ot">&lt;-</span>tr[treatment<span class="sc">==</span><span class="st">"C"</span> <span class="sc">&amp;</span>doctors<span class="sc">==</span>i]<span class="sc">+</span>doctor_var[[i]][<span class="dv">3</span>]</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>  recoveryTime <span class="ot">&lt;-</span> intercept<span class="sc">+</span>tr <span class="sc">+</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">unlist</span>(doctor_dosage)[<span class="fu">paste</span>(doctors,<span class="st">"."</span>,treatment,<span class="at">sep=</span><span class="st">""</span>)] <span class="sc">*</span> dosage <span class="sc">+</span> doctorIntercept[doctors] <span class="sc">+</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">rnorm</span>(numDoctors <span class="sc">*</span> numPatients, <span class="dv">0</span>, <span class="dv">2</span>)  <span class="co"># Add some observation noise</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">doctor =</span> doctors, <span class="at">treatment =</span> treatment, <span class="at">dosage =</span> dosage, <span class="at">recoveryTime =</span> recoveryTime)</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the data</span></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>data_int_interaction <span class="ot">&lt;-</span> <span class="fu">simulatePatientData</span>(<span class="at">numDoctors =</span> <span class="dv">3</span>,<span class="at">numPatients =</span> <span class="dv">200</span>,<span class="at">doctor_dosage=</span><span class="fu">list</span>(<span class="st">"1"</span><span class="ot">=</span><span class="fu">c</span>(<span class="at">A =</span> <span class="dv">3</span>, <span class="at">B =</span> <span class="sc">-</span><span class="dv">2</span>, <span class="at">C =</span> <span class="dv">1</span>),</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"2"</span><span class="ot">=</span><span class="fu">c</span>(<span class="at">A =</span> <span class="dv">3</span>, <span class="at">B =</span> <span class="sc">-</span><span class="dv">2</span>, <span class="at">C =</span> <span class="dv">1</span>),<span class="st">"3"</span><span class="ot">=</span><span class="fu">c</span>(<span class="at">A =</span> <span class="dv">3</span>, <span class="at">B =</span> <span class="sc">-</span><span class="dv">2</span>, <span class="at">C =</span> <span class="sc">-</span><span class="dv">1</span>)),<span class="at">doctor_var=</span><span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="fl">1.4</span>,<span class="dv">0</span>),<span class="fu">c</span>(<span class="fl">1.2</span>,<span class="dv">1</span>,<span class="dv">0</span>),<span class="fu">c</span>(<span class="fl">0.9</span>,<span class="dv">1</span>,<span class="dv">50</span>)))</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>data_int_interaction<span class="sc">$</span>treatment<span class="ot">&lt;-</span><span class="fu">factor</span>(data_int_interaction<span class="sc">$</span>treatment,<span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"A"</span>,<span class="st">"B"</span>,<span class="st">"C"</span>))</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a> <span class="fu">plot</span>(data_int_interaction<span class="sc">$</span>dosage,data_int_interaction<span class="sc">$</span>recoveryTime,<span class="at">col=</span><span class="fu">as.factor</span>(data_int_interaction<span class="sc">$</span>treatment),<span class="at">pch=</span><span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(data_int_interaction<span class="sc">$</span>doctor)),</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab=</span><span class="st">"Dosage"</span>,<span class="at">ylab=</span><span class="st">"Recovery time"</span>)</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a> <span class="fu">legend</span>(<span class="st">"top"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"Doctor"</span>, <span class="fu">unique</span>(data_int_interaction<span class="sc">$</span>doctor)),</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch =</span> <span class="fu">unique</span>(data_int_interaction<span class="sc">$</span>doctor), <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">title =</span> <span class="st">"Doctor"</span>,<span class="at">horiz=</span>T)</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topleft"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"Treatment"</span>, <span class="fu">levels</span>(data_int_interaction<span class="sc">$</span>treatment)),</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch=</span><span class="dv">1</span>,<span class="at">col =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">levels</span>(data_int_interaction<span class="sc">$</span>treatment)), <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">title =</span> <span class="st">"Treatment"</span>,<span class="at">horiz=</span>F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="tutorial-hac_files/figure-html/fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Scatter plot of treatment vs recovery time vs dosage
</figcaption>
</figure>
</div>
</div>
</div>
<p>What we believe is that there is dose-response relationship that is not uniform across all treatments. In other words, the impact of increasing dosage on treatment effectiveness might depend on the specific type of treatment being administered. To investigate this hypothesis, we incorporate interaction terms into our mixed model.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>model_lmm_treatment_dosse <span class="ot">&lt;-</span>  <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">*</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">|</span>doctor),data_int_interaction)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model_lmm_treatment_dosse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: recoveryTime ~ treatment * dosage + (1 | doctor)
   Data: data_int_interaction
REML criterion at convergence: 4366.567
Random effects:
 Groups   Name        Std.Dev.
 doctor   (Intercept) 9.874   
 Residual             9.170   
Number of obs: 600, groups:  doctor, 3
Fixed Effects:
      (Intercept)         treatmentB         treatmentC             dosage  
           50.905            -51.009             -7.324              2.950  
treatmentB:dosage  treatmentC:dosage  
           -4.708             -2.210  </code></pre>
</div>
</div>
<p>Similar to the previous case, we start assuming a random intercept in the model. What we see is that there is a big variation across different doctors when it comes to the baseline of the treatment A. However, here we only assumed that there is only the level of treatment A is random across the doctors. Let’s look at the fitted lines:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a> <span class="fu">plot</span>(data_int_interaction<span class="sc">$</span>dosage,data_int_interaction<span class="sc">$</span>recoveryTime,<span class="at">col=</span><span class="fu">as.factor</span>(data_int_interaction<span class="sc">$</span>treatment),<span class="at">pch=</span><span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(data_int_interaction<span class="sc">$</span>doctor)),</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab=</span><span class="st">"Dosage"</span>,<span class="at">ylab=</span><span class="st">"Recovery time"</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(dr <span class="cf">in</span> <span class="fu">unique</span>(data_int_interaction<span class="sc">$</span>doctor))</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_dosse)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>],</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_dosse)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">1</span>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_dosse)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_dosse)[[<span class="dv">1</span>]][dr,<span class="dv">2</span>],</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_dosse)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_dosse)[[<span class="dv">1</span>]][dr,<span class="dv">5</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">2</span>)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_dosse)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_dosse)[[<span class="dv">1</span>]][dr,<span class="dv">3</span>],</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_dosse)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_dosse)[[<span class="dv">1</span>]][dr,<span class="dv">6</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">3</span>)</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="tutorial-hac_files/figure-html/fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Scatter plot of treatment vs recovery time vs dosage, fitted lines
</figcaption>
</figure>
</div>
</div>
</div>
<p>What is clear is that the fit does not look that promising specially when it comes to the Doctor 3 (treatment C). One might suspect that the effect of dosage administration can also depend on the doctor. In this case, we need to model the dosage as random effect:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>model_lmm_treatment_doss_rnd <span class="ot">&lt;-</span>  <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">*</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>dosage<span class="sc">|</span>doctor),data_int_interaction)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model_lmm_treatment_doss_rnd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: recoveryTime ~ treatment * dosage + (1 + dosage | doctor)
   Data: data_int_interaction
REML criterion at convergence: 4363.593
Random effects:
 Groups   Name        Std.Dev. Corr 
 doctor   (Intercept) 11.5752       
          dosage       0.3271  -0.96
 Residual              9.1444       
Number of obs: 600, groups:  doctor, 3
Fixed Effects:
      (Intercept)         treatmentB         treatmentC             dosage  
           50.807            -50.937             -7.268              2.975  
treatmentB:dosage  treatmentC:dosage  
           -4.737             -2.218  </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a> <span class="fu">plot</span>(data_int_interaction<span class="sc">$</span>dosage,data_int_interaction<span class="sc">$</span>recoveryTime,<span class="at">col=</span><span class="fu">as.factor</span>(data_int_interaction<span class="sc">$</span>treatment),<span class="at">pch=</span><span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(data_int_interaction<span class="sc">$</span>doctor)),</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab=</span><span class="st">"Dosage"</span>,<span class="at">ylab=</span><span class="st">"Recovery time"</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(dr <span class="cf">in</span> <span class="fu">unique</span>(data_int_interaction<span class="sc">$</span>doctor))</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_doss_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>],</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_doss_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">1</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_doss_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_doss_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">2</span>],</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_doss_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_doss_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">5</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">2</span>)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_doss_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_doss_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">3</span>],</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_doss_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_doss_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">6</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">3</span>)</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="tutorial-hac_files/figure-html/fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted2-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: Scatter plot of treatment vs recovery time vs dosage, fitted lines
</figcaption>
</figure>
</div>
</div>
</div>
<p>Looking at the plot above and the output of the mixed model, the fit does not look much better than before. <code>Dosage</code> alone also does not seem to explain much of the variability. So what are we missing?</p>
<p>Similar to the previous scenario, not only the baseline treatment level (treatment A) is changing across the doctors but also the rate at which the doctors perform the treatment change. So let’s incorporate this:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>model_lmm_treatment_doss_trt_rnd <span class="ot">&lt;-</span>  <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">*</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>treatment<span class="sc">+</span>dosage<span class="sc">|</span>doctor),data_int_interaction)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model_lmm_treatment_doss_trt_rnd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: recoveryTime ~ treatment * dosage + (1 + treatment + dosage |  
    doctor)
   Data: data_int_interaction
REML criterion at convergence: 2791.263
Random effects:
 Groups   Name        Std.Dev. Corr             
 doctor   (Intercept)  4.8070                   
          treatmentB   0.3789  -1.00            
          treatmentC  22.4419   0.85 -0.85      
          dosage       0.3988  -0.84  0.84 -1.00
 Residual              2.4015                   
Number of obs: 600, groups:  doctor, 3
Fixed Effects:
      (Intercept)         treatmentB         treatmentC             dosage  
           50.462            -49.589             -4.396              3.096  
treatmentB:dosage  treatmentC:dosage  
           -5.068             -2.727  
optimizer (nloptwrap) convergence code: 0 (OK) ; 0 optimizer warnings; 1 lme4 warnings </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a> <span class="fu">plot</span>(data_int_interaction<span class="sc">$</span>dosage,data_int_interaction<span class="sc">$</span>recoveryTime,<span class="at">col=</span><span class="fu">as.factor</span>(data_int_interaction<span class="sc">$</span>treatment),<span class="at">pch=</span><span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(data_int_interaction<span class="sc">$</span>doctor)),</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab=</span><span class="st">"Dosage"</span>,<span class="at">ylab=</span><span class="st">"Recovery time"</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(dr <span class="cf">in</span> <span class="fu">unique</span>(data_int_interaction<span class="sc">$</span>doctor))</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_doss_trt_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>],</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_doss_trt_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">1</span>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_doss_trt_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_doss_trt_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">2</span>],</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_doss_trt_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_doss_trt_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">5</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">2</span>)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_doss_trt_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_doss_trt_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">3</span>],</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_doss_trt_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_doss_trt_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">6</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">3</span>)</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted3" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="tutorial-hac_files/figure-html/fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted3-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: Scatter plot of treatment vs recovery time vs dosage, fitted lines
</figcaption>
</figure>
</div>
</div>
</div>
<p>Now the fit looks much better than before. We can see in the output that the treatment C is now explaining a lot of variablity across different doctors. At this point the main question is given that we have assumed the differences in the treatment levels can be changing across the doctors could it be that the differences between the slopes are also random?</p>
<p>What this means is that so far, what we have done is modeling <code>(Intercept)</code>, <code>treatmentB</code>, <code>treatmentC</code>, <code>dosage</code> as random effects. But <code>treatmentB:dosage</code> and <code>treatmentC:dosage</code> are still fixed. This translate to a scenario that we believe there is a general differences between the doctors in a way that they administrate a <em>specific</em> treatment and also how they generally work with doses. But what if a doctor is much more skilled in administrating a dosage for a specific treatment?</p>
<p>In this case, we have to model the interaction as random effect:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>model_lmm_treatment_int_rnd <span class="ot">&lt;-</span>  <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">*</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>treatment<span class="sc">*</span>dosage<span class="sc">|</span>doctor),data_int_interaction)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model_lmm_treatment_int_rnd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: recoveryTime ~ treatment * dosage + (1 + treatment * dosage |  
    doctor)
   Data: data_int_interaction
REML criterion at convergence: 2580.411
Random effects:
 Groups   Name              Std.Dev. Corr                         
 doctor   (Intercept)        2.4125                               
          treatmentB         0.9628   1.00                        
          treatmentC        29.8136   0.43  0.43                  
          dosage             0.1635   0.86  0.86  0.84            
          treatmentB:dosage  0.2239  -1.00 -1.00 -0.47 -0.88      
          treatmentC:dosage  1.3260  -0.46 -0.46 -1.00 -0.85  0.50
 Residual                    2.0081                               
Number of obs: 600, groups:  doctor, 3
Fixed Effects:
      (Intercept)         treatmentB         treatmentC             dosage  
           50.644            -49.623             -4.641              3.050  
treatmentB:dosage  treatmentC:dosage  
           -5.027             -2.642  
optimizer (nloptwrap) convergence code: 0 (OK) ; 0 optimizer warnings; 1 lme4 warnings </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a> <span class="fu">plot</span>(data_int_interaction<span class="sc">$</span>dosage,data_int_interaction<span class="sc">$</span>recoveryTime,<span class="at">col=</span><span class="fu">as.factor</span>(data_int_interaction<span class="sc">$</span>treatment),<span class="at">pch=</span><span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(data_int_interaction<span class="sc">$</span>doctor)),</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab=</span><span class="st">"Dosage"</span>,<span class="at">ylab=</span><span class="st">"Recovery time"</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(dr <span class="cf">in</span> <span class="fu">unique</span>(data_int_interaction<span class="sc">$</span>doctor))</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_int_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>],</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_int_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">1</span>)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_int_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_int_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">2</span>],</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_int_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_int_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">5</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">2</span>)</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">coef</span>(model_lmm_treatment_int_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">1</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_int_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">3</span>],</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>       <span class="fu">coef</span>(model_lmm_treatment_int_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">4</span>]<span class="sc">+</span><span class="fu">coef</span>(model_lmm_treatment_int_rnd)[[<span class="dv">1</span>]][dr,<span class="dv">6</span>],<span class="at">lty=</span>dr,<span class="at">col=</span><span class="dv">3</span>)</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted4" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="tutorial-hac_files/figure-html/fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted4-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-plot-grouped-lmm-treatment-dose-random-effect-fitted4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12: Scatter plot of treatment vs recovery time vs dosage, fitted lines
</figcaption>
</figure>
</div>
</div>
</div>
<p>This final model tells that that the three main sources of variation in our data is <code>treatmentC</code>, <code>(Intercept)</code> and <code>treatmentC:dosage</code>. The fit also looks much better than before. This result translates to a scenario in which there is a variability between doctors in how they treat patients, there is a significant variability between then in the way they administrate the treatment C and also how they administrate dosage for treatment C.</p>
<p>To summarize this section, I want to point out that despite that there are some general terms such as random intercept or random slope models, one might often end up specifically model certain effects as random or fixed depending on the experimental design and characteristic of the samples and population. These effect should have been ideally studied prior to setting up the statistical model to avoid bias. In the next section we will have a look at some automated way of selecting fixed and random effect.</p>
</section>
<section id="model-selection-and-comparisons-using-lrt" class="level2">
<h2 class="anchored" data-anchor-id="model-selection-and-comparisons-using-lrt">Model selection and comparisons using LRT</h2>
<p>A critical step in using mixed models models effectively is determining which model provides the best fit to the data without overcomplicating the structure. ANOVA for mixed models serves as a tool for hypothesis testing between models, specifically testing if a more complex model significantly improves the explanation of data variability over a simpler one. Without going too much into the details (theory is covereted in the math section), what we are going to do is likelyhood ratio test (LRT) between different models. The Likelihood Ratio Test (LRT) is a statistical procedure used to compare the fit of two models to a set of data, where one model (the null model) is a special case of the other model (the alternative model). The LRT evaluates whether the more complex model significantly improves the fit to the data over the simpler model. The LRT is based on the likelihood ratio, which is a measure of how much more likely the data is under one model compared to another. Specifically, it compares the maximum likelihood of the data under the null hypothesis ((H_0), a simpler model with constraints on parameters) against the maximum likelihood under the alternative hypothesis ((H_1), a more complex model without those constraints).</p>
<p>In the case of mixed models, as you noticed, we have two sets of parameters to consider: fixed effects, which are common to all observations, and random effects, which vary across levels of a grouping factor (e.g., subjects, experiments, clusters). This dual nature adds a layer of complexity to model selection and comparison. Specifically, when conducting an LRT, we’re not only interested in how adding or removing fixed effects influences the model but also in how variations in the random effects structure contribute to explaining the data variability.</p>
<p>There are different approaches on how to apply model selection on mixed models. Here we are going to use a simple approach.</p>
<p>First we are going to use LRT to select the random part of the model. With random part of the model chosen, we will proceed with selecting the fixed part. <code>lme4</code> package provides <code>anova</code> function for doing so. As suggested by some authors, we are going to fit the models as complex as we believe they are and see whether a simpler model is preferred.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>When we apply model selection for the random part, all the models must have the same fixed structure. Similar, when working with fixed part, the random structure of the model must remain the same.</p>
</div>
</div>
<p>So let’s start with the random part of the model that included the interaction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">*</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">|</span>doctor),data_int_interaction, <span class="at">REML =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">*</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>treatment<span class="sc">|</span>doctor),data_int_interaction, <span class="at">REML =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">*</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>treatment<span class="sc">+</span>dosage<span class="sc">|</span>doctor),data_int_interaction, <span class="at">REML =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">*</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>treatment<span class="sc">*</span>dosage<span class="sc">|</span>doctor),data_int_interaction, <span class="at">REML =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">anova</span>(m1,m2,m3,m4,<span class="at">refit=</span><span class="cn">FALSE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Data: data_int_interaction
Models:
m1: recoveryTime ~ treatment * dosage + (1 | doctor)
m2: recoveryTime ~ treatment * dosage + (1 + treatment | doctor)
m3: recoveryTime ~ treatment * dosage + (1 + treatment + dosage | doctor)
m4: recoveryTime ~ treatment * dosage + (1 + treatment * dosage | doctor)
   npar    AIC    BIC  logLik deviance   Chisq Df Pr(&gt;Chisq)    
m1    8 4382.6 4417.7 -2183.3   4366.6                          
m2   13 2887.0 2944.2 -1430.5   2861.0 1505.55  5  &lt; 2.2e-16 ***
m3   17 2825.3 2900.0 -1395.6   2791.3   69.75  4  2.563e-14 ***
m4   28 2636.4 2759.5 -1290.2   2580.4  210.85 11  &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>The ANOVA table provides essential metrics for model comparison.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
ANOVA table columns
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><strong>Number of Parameters (npar):</strong></p>
<p>The ‘npar’ indicates the total number of parameters estimated by the model, reflecting its complexity.</p>
<p><strong>Akaike Information Criterion (AIC):</strong></p>
<p>AIC assesses the model quality, penalizing excessive complexity. Models with lower AIC values are generally preferred, as they give a balance between fitting the data well and being parsimonious.</p>
<p><strong>Bayesian Information Criterion (BIC):</strong></p>
<p>Similar to AIC, the BIC also rewards model fit but imposes a stricter penalty on the number of parameters. BIC is particularly useful for model selection in scenarios where overfitting is a concern, as its heavier penalty discourages unnecessarily complex models.</p>
<p><strong>Log-Likelihood (logLik):</strong></p>
<p>Log-likelihood is a direct measure of model fit, representing the logarithm of the likelihood function at its maximum point. Higher values indicate better fit.</p>
<p><strong>Deviance:</strong></p>
<p>Derived from the log-likelihood, deviance is a measure of model fit that allows direct comparison between models. It is defined as twice the difference between the maximum log-likelihood and the log-likelihood under the model being tested. Lower deviance values indicate a better fit to the data.</p>
<p><strong>Chi-Squared Test (Chisq) and Degrees of Freedom (Df):</strong></p>
<p>These metrics are used to test whether the addition of parameters (and thus, complexity) significantly improves the model fit. The chi-squared statistic tests the null hypothesis that both models fit the data equally well. The degrees of freedom, calculated as the difference in parameters between models, help determine the critical value for this test.</p>
<p><strong>Probability Value (Pr(&gt;Chisq)):</strong></p>
<p>A low p-value (typically &lt;0.05) indicates that the more complex model provides a significantly better fit to the data, justifying its additional complexity.</p>
</div>
</div>
</div>
<p>The table is sorted based on the complexity of the model (the number of parameters). The first row is the least and the last row is the most complex model. The columns used for comparisons the <code>Pr(&gt;Chisq)</code> (p-value) is comparions the current row to the previous one. So let’s start interpreting the results from the table, it’s evident that each successive, more complex model significantly improves the fit to the data over its predecessor, as indicated by the <code>Pr(&gt;Chisq)</code> column. This p-value compares the current model to the previous one in terms of how much more likely the data is under the more complex model.</p>
<p>Starting with model m1, which includes a random intercept for doctors, we observe a baseline for comparison. This model sets the foundation with a certain number of parameters (npar = 8), Akaike Information Criterion (AIC), Bayesian Information Criterion (BIC), log-likelihood (logLik), and deviance scores.</p>
<p>When we move to model m2, which adds treatment as a random slope alongside the doctor, we see a substantial improvement in model fit. This is evidenced by the dramatic reduction in AIC and BIC values and a significant chi-squared statistic (Chisq = 1505.55) with a p-value less than 2.2e-16, indicating a highly significant improvement over m1. The addition of treatment as a random effect accounts for the variability in treatment effects across doctors, enhancing the model’s explanatory power.</p>
<p>The transition from m2 to m3, where dosage is added as another random slope, continues to show significant model improvement, albeit the magnitude of improvement is less dramatic than the previous step. This is reflected in the Chisq value of 69.75 with a p-value of 2.563e-14, indicating that incorporating dosage variability across doctors further refines our model’s accuracy.</p>
<p>Finally, model m4, which introduces an interaction between treatment and dosage as a random slope, marks the most substantial complexity increase, as shown by the jump in the number of parameters to 28. This model shows another significant leap in fit, with a Chisq value of 210.85 and a p-value less than 2.2e-16. The substantial decrease in AIC and BIC values alongside this indicates that considering the interaction between treatment and dosage in the model’s random effects structure captures a critical aspect of the data’s underlying structure, providing the best fit among the compared models.</p>
<p>In summary, the progression from m1 to m4 illustrates a clear trajectory of increasing model complexity leading to significantly improved fits to the data, as demonstrated by decreasing AIC/BIC values and highly significant p-values in the likelihood ratio tests.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please note that in order to compare the random effect part, we HAVE to set <code>refit=FALSE</code> in the anova function. The reason for this is that using <code>refit=FALSE</code> would use the original estimation method, which in our case was Restricted Maximum Likelihood (REML). REML adjusts for the loss of degrees of freedom when estimating fixed effects, providing unbiased estimates of variance components. We must always use <code>REML = TRUE</code> when fitting and reporting mixed models. However, REML assumes that the fixed effects structure is correct. So in order to compare fixed effect part of the model, we need to use <code>refit=TRUE</code> or fit the original mixed model using <code>REML = FALSE</code> only for the purpose of comparing the fixed effects. The repoted/final model must always be based on <code>REML = TRUE</code>. More about this in the math section.</p>
</div>
</div>
<p>Give we now know that our interaction model was the best one, we can now proceed with refining our model by selecting the most appropriate fixed effects. We will keep the random part constant across the models and change the fixed part:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span><span class="dv">1</span><span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>treatment<span class="sc">*</span>dosage<span class="sc">|</span>doctor),data_int_interaction, <span class="at">REML =</span> <span class="cn">FALSE</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>treatment<span class="sc">*</span>dosage<span class="sc">|</span>doctor),data_int_interaction, <span class="at">REML =</span> <span class="cn">FALSE</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">+</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>treatment<span class="sc">*</span>dosage<span class="sc">|</span>doctor),data_int_interaction, <span class="at">REML =</span> <span class="cn">FALSE</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(recoveryTime<span class="sc">~</span>treatment<span class="sc">*</span>dosage<span class="sc">+</span>(<span class="dv">1</span><span class="sc">+</span>treatment<span class="sc">*</span>dosage<span class="sc">|</span>doctor),data_int_interaction, <span class="at">REML =</span> <span class="cn">FALSE</span>)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">anova</span>(m1,m2,m3,m4,<span class="at">refit=</span><span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Data: data_int_interaction
Models:
m1: recoveryTime ~ 1 + (1 + treatment * dosage | doctor)
m2: recoveryTime ~ treatment + (1 + treatment * dosage | doctor)
m3: recoveryTime ~ treatment + dosage + (1 + treatment * dosage | doctor)
m4: recoveryTime ~ treatment * dosage + (1 + treatment * dosage | doctor)
   npar    AIC    BIC  logLik deviance   Chisq Df Pr(&gt;Chisq)    
m1   23 2657.9 2759.0 -1305.9   2611.9                          
m2   25 2646.2 2756.2 -1298.1   2596.2 15.6092  2  0.0004078 ***
m3   26 2647.7 2762.0 -1297.8   2595.7  0.5915  1  0.4418240    
m4   28 2632.4 2755.5 -1288.2   2576.4 19.2892  2  6.477e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>Starting with model m1, which serves as our baseline model including only the intercept in the fixed part, we assess the improvement in fit as we incrementally add fixed effects. Model m1 establishes the groundwork with specific values for the number of parameters (npar), AIC, BIC, log-likelihood (logLik), and deviance.</p>
<p>The progression to model m2, which introduces treatment as a fixed effect, gives a big improvement in the model’s explanatory power. This is clear by a decrease in both AIC and BIC scores and a significant chi-squared statistic (Chisq = 15.6092) with a p-value of 0.0004078. The statistical significance indicates that the inclusion of treatment as a fixed effect significantly enhances the model’s fit over the baseline model, which is consistent with the expectation that treatment would have a systematic effect on recovery time.</p>
<p>Going to model m3, which further includes dosage alongside treatment in the fixed effects, we observe a marginal change. The chi-squared statistic (Chisq = 0.5915) with a p-value of 0.4418240 suggests that the addition of dosage as a fixed effect does not significantly improve the model’s fit beyond what is achieved by including treatment alone.</p>
<p>Model m4 reintroduces the treatment by dosage interaction in the fixed effects, reflecting the most complex fixed-effects structure among the evaluated models. The significant reduction in AIC and BIC values, coupled with a chi-squared statistic (Chisq = 19.2892) and a p-value of 6.477e-05, shows the critical importance of this interaction term. The substantial improvement in model fit indicates that the interaction between treatment and dosage is a key factor in explaining variations in recovery time, warranting its inclusion in both the fixed and random components of the model.</p>
<p>We now know that our final model should be in the form of <code>lmer(recoveryTime~treatment*dosage+(1+treatment*dosage|doctor),data_int_interaction, REML = TRUE)</code>. Please note that we use <code>REML=TRUE</code> in the final model.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>It is always a good practice to design the model based on the population/sample structure and experimental design. Despite model selection being a powerful tool, it cannot replace the necessity for substantive knowledge and theoretical understanding of the phenomena under study. Relying solely on automated procedures or statistical criteria (like AIC or BIC) for model selection can lead to overfitting, misinterpretation of model parameters, and conclusions that do not accurately reflect the underlying processes. Moreover, important variables might be overlooked if they are not considered in the model selection process. Hence, it’s crucial to integrate domain expertise with statistical approaches, ensuring that the chosen model is both statistically sound and theoretically justified.</p>
</div>
</div>
</section>
</section>
<section id="try-it-yourself" class="level1">
<h1>Try it yourself</h1>
<p>Data for exercises are in can be found <a href="aaaa">here</a></p>
<section id="vaccine-study" class="level2">
<h2 class="anchored" data-anchor-id="vaccine-study">Vaccine study</h2>
<p>The data come from a trial evaluating a vaccine based on HIV-1 lipopeptides in HIV-negative volunteers. The vaccine (HIV-1 LIPO-5 ANRS vaccine) contains five HIV-1 amino acid sequences coding for Gag, Pol and Nef proteins. This data set contains the expression measure of a subset of 1000 genes from purified in vitro stimulated Peripheral Blood Mononuclear Cells from 42 repeated samples (12 unique vaccinated participants) 14 weeks after vaccination, , 6 hours after in vitro stimulation by either (1) all the peptides included in the vaccine (LIPO-5), or (2) the Gag peptides included in the vaccine (GAG+) or (3) the Gag peptides not included in the vaccine (GAG-) or (4) without any stimulation (NS).</p>
<p>The data is a list containing the following components:</p>
<ul>
<li><p>list(“gene”) data frame with 42 rows and 1000 columns. The expression measure of 1000 genes for the 42 samples (PBMC cells from 12 unique subjects).</p></li>
<li><p>list(“stimulation”) is a fctor of 42 elements indicating the type of in vitro simulation for each sample.</p></li>
<li><p>list(“sample”) is a vector of 42 elements indicating the unique subjects (for example the value ‘1’ correspond to the first patient PBMC cells). Note that the design of this study is unbalanced.</p></li>
<li><p>list(“tab.prob.gene”) is a data frame with 1000 rows and 2 columns, indicating the Illumina probe ID and the gene name of the annotated genes.</p></li>
</ul>
<p>Your task is to do all pairwise comparisons of the simulations and report the genes that are statistically significantly changing in any of the conditions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the data</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"vaccine.rda"</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co"># name of the list: vaccine</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="vaccine-study-1" class="level2">
<h2 class="anchored" data-anchor-id="vaccine-study-1">Vaccine study</h2>
<p>This data set contains the expression measure of 3116 genes and 10 clinical measurements for 64 rats (repeating samples) that were exposed to non-toxic, moderately toxic or severely toxic doses of acetaminophen in a controlled experiment.</p>
<p>Data is a list containing the following components:</p>
<ul>
<li><p>list(“gene”) data frame with 64 rows and 3116 columns. The expression measure of 3116 genes for the 64 subjects (rats).</p></li>
<li><p>list(“clinic”) data frame with 64 rows and 10 columns, containing 10 clinical variables for the same 64 subjects.</p></li>
<li><p>list(“treatment”) data frame with 64 rows and 4 columns, containing the treatment information on the 64 subjects, such as doses of acetaminophen and times of necropsies. This includes animal id</p></li>
<li><p>list(“gene.ID”) data frame with 3116 rows and 2 columns, containing geneBank IDs and gene titles of the annotated genes</p></li>
</ul>
<p>Your goal is to identify genes whose expression levels interact significantly with the dosage to affect clinical measurements.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the data</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"liver.rda"</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co"># name of the list: data_liver</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>